name: Alarm Sistemi

on:
  schedule:
    - cron: '30 7  * * 1-5'
    - cron: '15 11 * * 1-5'
    - cron: '15 12 * * 1-5'
    - cron: '45 14 * * 1-5'
  workflow_dispatch:

jobs:
  alarm:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --quiet \
            yfinance pandas numpy requests python-dotenv \
            groq beautifulsoup4 rich

      - name: Log gold price
        run: |
          mkdir -p raporlar
          python - << 'PYEOF'
          import json, requests
          from datetime import datetime
          from pathlib import Path
          log_dosya = Path("raporlar/altin_fiyat_log.json")
          log = []
          if log_dosya.exists():
              try:
                  log = json.loads(log_dosya.read_text())
              except:
                  pass
          kayit = {"tarih": datetime.now().strftime("%Y-%m-%d %H:%M")}
          for sembol, url in [("XAU","https://api.gold-api.com/price/XAU"),
                               ("XAG","https://api.gold-api.com/price/XAG")]:
              try:
                  r = requests.get(url, timeout=6)
                  if r.status_code == 200:
                      kayit[sembol] = r.json().get("price")
              except:
                  pass
          log.append(kayit)
          log = log[-500:]
          log_dosya.write_text(json.dumps(log, ensure_ascii=False, indent=2))
          print("Gold log:", kayit)
          PYEOF

      - name: Run alarm system
        env:
          GROQ_API_KEY:       ${{ secrets.GROQ_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python bist_sistem.py

      - name: Run denetci
        env:
          GROQ_API_KEY:       ${{ secrets.GROQ_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python bist_denetci.py --kural --backtest
          mv denetim_raporu_*.json raporlar/ 2>/dev/null || true

      - name: Commit logs
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add raporlar/ 2>/dev/null || true
          git diff --staged --quiet || git commit -m "alarm log $(date +'%Y-%m-%d %H:%M')"
          git push
